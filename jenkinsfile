pipeline {
    agent any
 
    stages {
        stage('Checkout') {
            steps {
                // Checkout your repository
                git branch:'dev_1', url: 'https://github.com/Thilaga219/React_docker.git'
                sh 'ls -l'
            }
        }
 
        stage('Before Install') {
            steps {
                script {
                    // Build and run the Docker containers
                    echo "####Dev build started##########"
                    sh 'docker build -t thilaga219/react-test -f ./client/Dockerfile.dev ./client/Dockerfile.dev'
                    echo "####Dev build Ended######"
                }
            }
        }
 
        stage('Test') {
            steps {
                script {
                    echo "#######Test Started#########"
                    // Test if the web service is running
                    sh 'docker run -e CI=true thilaga219/react-test npm test -- --coverage'
                    echo "#######Test Ended#########"
                }
            }
        }

        stage('Build Final Images') {
            steps {
                script {
                    // Stop and remove the containers
                    echo "######Final Images built started#####"
                    sh """ 
                    docker build -t thilaga219/multi-client ./client
                    sudo docker build -t thilaga219/multi-nginx ./nginx
                    sudo docker build -t thilaga219/multi-server ./server
                    sudo docker build -t thilaga219/multi-worker ./worker 
                    """
                    echo "####Final Images built completed######"
                }
            }
        }
        
        stage('Push images to DockerHub') {
            steps {
                script {
                    // Stop and remove the containers
                    echo "#####Login Started#####"
                    withCredentials([usernamePassword(credentialsId: 'DockerHub_credentials', usernameVariable: 'username', passwordvariable: 'password')])
                    {
                    sh 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin'
                    }
                    echo "#####Login completed#####"
                    echo "*****************Images push to DokcherHub started************"
                    sh """
                    sudo docker push thilaga219/multi-client
                    sudo docker push thilaga219/multi-nginx
                    sudo docker push thilaga219/multi-server
                    sudo docker push thilaga219/multi-worker
                    """
                    echo "*****************Images push to DokcherHub Complted************"

                    cleanWs()
                }
            }
        }
}
}
